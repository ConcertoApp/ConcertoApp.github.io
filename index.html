<!DOCTYPE html>
<html>

<head style="background-color: black">
    <meta charset="UTF-8">
    <title>Concerto</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:500" rel="stylesheet">
    
    <style>
        body{
            font-family: 'Roboto', sans-serif;
            font-size: 18px;
            font-variant-numeric: tabular-nums;
            margin: 0;
            color: #ff2024;
        }
        .EdgyButton{
            margin-top: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 18px;
            background-color: #ff2024;
            border: 3px solid #ff2024;
        }
        .EdgyButtonHidden{
            margin-top: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 18px;
            background-color: #ff2024;
            border: 3px solid #ff2024;
            visibility: hidden;
        }
        .EdgyInput{
            font-family: 'Roboto', sans-serif;
            font-size: 18px; color: #ff2024;
            background-color: black;
            border: 3px solid #ff2024;
        }
    </style>
    
</head>

<body onload="resizeStuff()"; onresize="resizeStuff()">

    <div id="ConcertoApp" style='overflow: hidden; background-color: black;'>

        <div id="overlay">
            <img src="concertomonogram.png" style="width:70%; margin-left: 15%; margin-top: 1%;">
            <div id="ProgBar" style="width: 0%; height: 10px; background-color: #ff2024;"></div><br>
            <div id="countdown"></div><br>
        </div>

        <div id="content" style="position: absolute; width: 100%;">
            <div id="commands" style="margin-left: 6.25%; float:left; width: 40%; height: 66%; overflow-y: scroll; overflow-x: hidden;">
                <div id="commandscontent" style="margin-left: 3px; margin-right: 3px; margin-top: 3px; margin-bottom: 3px;">
                    <div id="topcommands">
                        <input id="Input" value="" class="EdgyInput">
                        <button id="Btn" onclick="javascript:buttonpress()" class="EdgyButton">Add Song</button>
                        <button id="PlayBtn" onclick="javascript:buttonpress2()" class="EdgyButtonHidden">Test</button>
                    </div>

                    <br>
                    <div id="Tracklist"></div>
                    <br>

                    <div id="bottomcommands" style="visibility : hidden">
                        Seconds until start: <input class="EdgyInput" id="Seconds">
                        <button id="linkBtn" onclick="javascript:buttonpress3()" class="EdgyButton">Get Link</button>
                        <div id="linkspot"></div><br>
                    </div>
                </div>
            </div>

            <div id="lyricscontainer" style="margin-right: 6.25%; float:right; width: 40%; height: 66%; overflow-y: scroll; overflow-x: hidden;">
                <div id="lyrics" style="margin-left: 3px; margin-right: 3px; margin-top: 3px; margin-bottom: 3px;"></div>
            </div>
        </div>

        <div id="CHROMEKILLER" style="position:absolute; width:1px; height: 1px; overflow: hidden;">
            <div id="iframehere" style="padding-left: 500px;"></div>
        </div>

    </div>

    <script>
        var cors_api_url = 'https://cors-anywhere.herokuapp.com/';
        var youtubeURL = '';
        var youtubeID = '';
        var iframe;
        var duration;
        var videos = [];
        var durations = [];
        var titles = [];
        var loading = false;
        var playing = false;
        var added = false;
        var timestamp;
        var hashlist = [];
        var startTime;
        var currentTime;
        var link;
        var hash = window.location.hash.split('&amp;').join('&');
        var lyricsUrl;
        var lyrics;
        var currentDuration;
        /*--------------------------------------------RESIZE CODE-----------------------------------------------*/
        function resizeStuff() {
            console.log("Resized!");
            document.getElementById("ConcertoApp").style.height = window.innerHeight + "px";
            document.getElementById("commands").style.height = (window.innerHeight * .66) + "px";
            document.getElementById("lyricscontainer").style.height = (window.innerHeight * .66) + "px";

            if(document.getElementById("commandscontent").clientHeight + 6 > (window.innerHeight * .66)){
                document.getElementById("commands").style.overflowY = "scroll";
            } else {
                document.getElementById("commands").style.overflowY = "hidden";
            }
            if(document.getElementById("lyrics").clientHeight + 6> (window.innerHeight * .66)){
                document.getElementById("lyricscontainer").style.overflowY = "scroll";
            } else {
                document.getElementById("lyricscontainer").style.overflowY = "hidden";
            }
        //    document.getElementById("content").style.marginTop = Math.round((((document.getElementById("ConcertoApp").clientHeight - document.getElementById("overlay").clientHeight) - document.getElementById("content").clientHeight) / 2)) + "px";
        }
        /*----------------------------------------------UI CODE-------------------------------------------------*/
        function updateProgBar(duration, maxduration) {
            document.getElementById("ProgBar").style.width = (duration / maxduration) * 100 + "%";
        }
        function playProgBar(duration) {
            document.getElementById("ProgBar").style.width = "0%";
            currentDuration = 0;
            for (var i = 0; i < duration * 20; i++) {
                setTimeout(function() {
                    currentDuration += .05;
                    updateProgBar(currentDuration, duration);
                }, i * 50);
            }
        }
        /*---------------------------------------------CORS CODE-----------------------------------------------*/
        function doCORSRequest(options, printResult) {
            var x = new XMLHttpRequest();
            x.open(options.method, cors_api_url + options.url);
            x.onload = x.onerror = function() {
                printResult(
                    options.method + ' ' + options.url + '\n' +
                    x.status + ' ' + x.statusText + '\n\n' +
                    (x.responseText || '')
                );
            };
            if (/^POST/i.test(options.method)) {
                x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            }
            x.send(options.data);
        }
        function getDataOnly(myurl, songtitle) {
            doCORSRequest({
                method: 'GET',
                url: myurl,
                data: ""
            }, function printResult(result) {
                getData(result);
                document.getElementById("Btn").style.visibility = "visible";
                document.getElementById("PlayBtn").style.visibility = "visible";
                document.getElementById("Tracklist").innerHTML = document.getElementById("Tracklist").innerHTML + timestamp + " | " + songtitle + "<br>";
                titles.push(songtitle);
                loading = false;
                added = true;
                document.getElementById("bottomcommands").style.visibility = "visible";
                document.getElementById("linkBtn").style.visibility = "visible";
            });
        }
        function getLyricsFromUrl(myurl) {
            doCORSRequest({
                method: 'GET',
                url: myurl,
                data: ""
            }, function printResult(result) {
                var firstLyricsBit = result.substring(result.indexOf('<p id="songLyricsDiv"  class="songLyricsV14 iComment-text">') + 59);
                lyrics = firstLyricsBit.substring(0, firstLyricsBit.indexOf('</div>'));
                document.getElementById("lyrics").innerHTML = lyrics;
            });
        }
        function getLyricsSearchResults(myurl) {
            doCORSRequest({
                method: 'GET',
                url: myurl,
                data: ""
            }, function printResult(result) {
                var firstSongBit = result.substring(result.indexOf('<div class="serpresult">') + 42);
                lyricsUrl = firstSongBit.substring(0, firstSongBit.indexOf('/"'));
                getLyricsFromUrl(lyricsUrl);
            });
        }
        /*--------------------------------------------BTUTON CODE----------------------------------------------*/
        var input = document.getElementById("Input");
        input.addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.getElementById("Btn").click();
            }
        });
        var input2 = document.getElementById("Seconds");
        input2.addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.getElementById("linkBtn").click();
            }
        });
        function buttonpress() {
            if (!loading) {
                loading = true;
                document.getElementById("linkBtn").style.visibility = "hidden";
                document.getElementById("Btn").style.visibility = "hidden";
                document.getElementById("PlayBtn").style.visibility = "hidden";
                dataFromName(document.getElementById("Input").value);
                document.getElementById("Input").value = "";
            }
        }
        function buttonpress2() {
            if (!playing && !loading) {
                document.getElementById("PlayBtn").style.visibility = "hidden";
                playing = true;
                playList(videos, durations, titles);
            }
        }
        function buttonpress3() {
            if (!loading && added) {
                link = document.createElement('a');
                link.innerHTML = getLink((Math.floor(Date.now() / 1000) + JSON.parse(document.getElementById("Seconds").value)) * 1000, videos, durations);
                link.href = 'javascript:linkcode()';
                link.style.color="#ff2024";
                document.getElementById("linkspot").appendChild(link);
            }
        }
        function linkcode() {
            window.location = link.innerHTML;
            location.reload();
        }
        /*--------------------------------------------MAKE CODE---------------------------------------------*/
        function getData(result) {
            var firstbit = result.substring(result.indexOf('https://www.youtube.com'));
            youtubeURL = firstbit.substring(0, firstbit.indexOf('"'));
            youtubeID = youtubeURL.substring(youtubeURL.indexOf('watch?v=') + 8);
            var firstdirbit = firstbit.substring(firstbit.indexOf('▶ ') + 2);
            timestamp = firstdirbit.substring(0, firstdirbit.indexOf('</span>'));
            var minutes = Math.floor(timestamp.substring(0, timestamp.indexOf(":")));
            var seconds = Math.floor(timestamp.substring(timestamp.indexOf(":") + 1));
            duration = (minutes * 60) + seconds;
            durations.push(duration);
            videos.push(youtubeID);
        }
        function dataFromName(query) {
            getDataOnly("http://results.dogpile.com/serp?qc=video&q=" + query.split(' ').join('+'), query);
        }
        /*------------------------------------------PLAY CODE----------------------------------------------*/
        function playdelay(name, time, isnotFirst, friendlyname, length) {
            if (isnotFirst) {
                setTimeout(function() {
                    removeVideo();
                    playVideo(name, friendlyname, length);
                }, time);
            } else {
                setTimeout(function() {
                    playVideo(name, friendlyname, length);
                }, time);
            }
        }
        function playList(videos, durations) {
            var notFirst = false;
            var cumulativedur = 0;
            for (i = 0; i < videos.length; i++) {
                playdelay(videos[i], cumulativedur, notFirst, titles[i], durations[i]);
                cumulativedur = cumulativedur + ((durations[i] + 6) * 1000);
                notFirst = true;
            }
        }
        function playVideo(url, friendlyname, length) {
            ifrm = document.createElement('iframe');
            ifrm.setAttribute('id', 'ifrm');
            document.getElementById("iframehere").appendChild(ifrm);
            ifrm.setAttribute('src', 'https://www.youtube.com/embed/' + url + '?ecver=1&autoplay=1&iv_load_policy=1&yt:stretch=16:9&autohide=1&color=red&width=560&width=560');
            ifrm.setAttribute('allow', "autoplay");
            LyricsFromName(friendlyname);
            playProgBar(length);
        }
        function removeVideo() {
            ifrm.remove();
        }
        /*------------------------------------------JOIN CODE----------------------------------------------*/
        if (window.location.hash.length > 0) {
            document.getElementById("topcommands").style.visibility = "hidden";
            setInterval(onTimerTick, 33);
            startTime = hash.substring(1, hash.indexOf("&"));
            currentTime = Date.now();
            hashlist = (hash.substring(hash.indexOf("&") + 1)).split(",");
            for (var i = 0; i < hashlist.length; i++) {
                videos.push(hashlist[i]);
                i++;
                durations.push(JSON.parse(hashlist[i]));
                i++;
                titles.push(hashlist[i].split("-").join(" "));
            }
            listOut();
            setTimeout(function() {
                document.getElementById("PlayBtn").click();
            }, startTime - currentTime);
        }
        function getLink(time, videos, durations) {
            hashlist = [];
            for (var i = 0; i < videos.length; i++) {
                hashlist.push(videos[i]);
                hashlist.push(durations[i]);
                hashlist.push(titles[i].split(" ").join("-"));
            }
            return window.location.origin + "/#" + time + "&" + hashlist.toString();
        }
        function timeStamp(seconds) {
            return Math.floor(seconds / 60) + ":" + ('0' + (seconds % 60)).slice(-2);
        }
        function onTimerTick() {
            if (Math.floor((startTime - Date.now()) / 1000) > 0) {
                document.getElementById("countdown").innerHTML = timeStamp(Math.floor((startTime - Date.now()) / 1000));
            } else {
                document.getElementById("countdown").innerHTML = "";
            }
        }
        function listOut() {
            for (var i = 0; i < videos.length; i++) {
                songtitle = titles[i];
                timestamp =
                    document.getElementById("Tracklist").innerHTML = document.getElementById("Tracklist").innerHTML + timeStamp(durations[i]) + " | " + songtitle + "<br>";
            }
        }
        function LyricsFromName(name) {
            getLyricsSearchResults('http://www.songlyrics.com/index.php?section=search&searchW=' + name.split(' ').join('+') + '&submit=Search');
        }
    </script>

</body>

</html>
