<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Concerto</title>
</head>

<body>
    
    <div id="countdown"></div>
    
<div id="commands">
    <div id="topcommands">
    <input id="Input" value="">
    <button id="Btn" onclick="javascript:buttonpress()">Add Song</button>
    <button id="PlayBtn" onclick="javascript:buttonpress2()">Play</button>
    </div>
        
    <br> <br>
    <div id="Tracklist"></div>
    <br>
      
    <div id="bottomcommands" style="visibility : hidden">
        Seconds until start: <input id="Seconds"> <button id="linkBtn" onclick="javascript:buttonpress3()">Get Link</button>
        <div id="linkspot"></div><br>
    </div>
</div>
    
    <script>
        var cors_api_url = 'https://cors-anywhere.herokuapp.com/';
        var youtubeURL = '';
        var youtubeID = '';
        var iframe;
        var duration;
        var videos = [];
        var durations = [];
        var loading = false;
        var playing = false;
        var added = false;
        var timestamp;
        var hashlist = [];
        var startTime;
        var currentTime;
        var link;
        var hash = window.location.hash.split('&amp;').join('&');
        
        /*--------------------------------------------BTUTON CODE----------------------------------------------*/
        
        var input = document.getElementById("Input");
        input.addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                document.getElementById("Btn").click();
            }
        });
        function buttonpress() {
            if (!loading) {
                loading = true;
                document.getElementById("linkBtn").style = "visibility: hidden";
                document.getElementById("Btn").style = "visibility: hidden";
                document.getElementById("PlayBtn").style = "visibility: hidden";
                console.log("pressed");
                dataFromName(document.getElementById("Input").value);
                document.getElementById("Input").value = "";
            }
        }
        function buttonpress2() {
            if (!playing && !loading) {
                document.getElementById("PlayBtn").style = "visibility: hidden";
                playing = true;
                playList(videos, durations);
            }
        }
        function buttonpress3() {
            if (!loading && added) {
                link = document.createElement('a');
                link.innerHTML = getLink((Math.floor(Date.now() / 1000) + JSON.parse(document.getElementById("Seconds").value)) * 1000, videos, durations);
                link.href = 'javascript:linkcode()';
                document.getElementById("linkspot").appendChild(link);
            }
        }
        function linkcode() {
            window.location = link.innerHTML;
            location.reload();
        }
        
        /*--------------------------------------------MAIN CODE---------------------------------------------*/
        
        function doCORSRequest(options, printResult) {
            var x = new XMLHttpRequest();
            x.open(options.method, cors_api_url + options.url);
            x.onload = x.onerror = function() {
                printResult(
                    options.method + ' ' + options.url + '\n' +
                    x.status + ' ' + x.statusText + '\n\n' +
                    (x.responseText || '')
                );
            };
            if (/^POST/i.test(options.method)) {
                x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            }
            x.send(options.data);
        }
        function getDataOnly(myurl, songtitle) {
            doCORSRequest({
                method: 'GET',
                url: myurl,
                data: ""
            }, function printResult(result) {
                getData(result);
                document.getElementById("Btn").style = "visibility: visible";
                document.getElementById("PlayBtn").style = "visibility: visible";
                document.getElementById("Tracklist").innerHTML = document.getElementById("Tracklist").innerHTML + timestamp + " | " + songtitle + "<br>";
                loading = false;
                added = true;
                document.getElementById("bottomcommands").style = "visibility: visible";
                document.getElementById("linkBtn").style = "visibility: visible";
            });
        }
        function playVideo(url) {
            console.log(url);
            ifrm = document.createElement('iframe');
            ifrm.setAttribute('id', 'ifrm');
            document.body.appendChild(ifrm);
            ifrm.setAttribute('src', 'https://www.youtube.com/embed/' + url + '?ecver=1&autoplay=1&iv_load_policy=1&yt:stretch=16:9&autohide=1&color=red&width=560&width=560');
            ifrm.setAttribute('allow', "autoplay");
        }
        function removeVideo() {
            ifrm.remove();
        }
        function getData(result) {
            var firstbit = result.substring(result.indexOf('https://www.youtube.com'));
            youtubeURL = firstbit.substring(0, firstbit.indexOf('"'));
            youtubeID = youtubeURL.substring(youtubeURL.indexOf('watch?v=') + 8);
            var firstdirbit = firstbit.substring(result.indexOf('â–¶ ') + 2);
            timestamp = firstdirbit.substring(0, firstdirbit.indexOf('</span>'));
            var minutes = Math.floor(timestamp.substring(0, timestamp.indexOf(":")));
            var seconds = Math.floor(timestamp.substring(timestamp.indexOf(":") + 1));
            duration = (minutes * 60) + seconds;
            durations.push(duration);
            videos.push(youtubeID);
        }
        function dataFromName(query) {
            getDataOnly("http://results.dogpile.com/serp?qc=video&q=" + query.split(' ').join('+') + "+topic", query);
        }
        function playdelay(name, time, isnotFirst) {
            if (isnotFirst) {
                setTimeout(function() {
                    removeVideo();
                    console.log("hey");
                    playVideo(name);
                }, time);
            } else {
                setTimeout(function() {
                    console.log("hey");
                    playVideo(name);
                }, time);
            }
        }
        function playList(videos, durations) {
            var notFirst = false;
            var cumulativedur = 0;
            for (i = 0; i < videos.length; i++) {
                playdelay(videos[i], cumulativedur, notFirst);
                cumulativedur = cumulativedur + ((durations[i] + 6) * 1000);
                console.log(i + " | " + cumulativedur + " | " + durations[i]);
                notFirst = true;
            }
        }
        
        /*---------------------------------------LINK/TIMER CODE--------------------------------------------*/
        
        if (window.location.hash.length > 0) {
            
            document.getElementById("topcommands").style = "visibility: hidden";
            setInterval(onTimerTick, 33);
            
            startTime = hash.substring(1, hash.indexOf("&"));
            currentTime = Date.now();
            hashlist = (hash.substring(hash.indexOf("&") + 1)).split(",");
            for (var i = 0; i < hashlist.length; i++) {
                videos.push(hashlist[i]);
                i++;
                durations.push(JSON.parse(hashlist[i]));
            }
            setTimeout(function() {
                document.getElementById("PlayBtn").click();
            }, startTime - currentTime);
        }
        function getLink(time, videos, durations) {
            hashlist = [];
            for (var i = 0; i < videos.length; i++) {
                hashlist.push(videos[i]);
                hashlist.push(durations[i]);
            }
            return window.location.origin + "/#" + time + "&" + hashlist.toString();
        }
        
        function timeStamp(seconds) {
            return Math.floor(seconds/60) + ":" + seconds % 60;
        }
        
        function onTimerTick(){
            if(Math.floor((startTime-currentTime) / 1000) > 0){
                document.getElementById("countdown").innerHTML = getLink(Math.floor((startTime-currentTime) / 1000));
            } else {
                document.getElementById("countdown").innerHTML = "";
            }
        }
        
    </script>

</body>

</html>
